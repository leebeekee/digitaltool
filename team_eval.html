<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‰ê°€í•˜ê¸°</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <!-- ê¸°ë³¸ê°’: 1ì¡° í‰ê°€ (ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ì „ì—ë„ ë³´ì„) -->
                <h1 id="pageTitle">1ì¡° í‰ê°€</h1>
            </div>
        </header>

        <a href="evaluate.html" class="back-btn">&larr; ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        
        <div class="card">
            <!-- ê¸°ë³¸ê°’: 1ì¡° ì •ë³´ -->
            <h2 id="teamName">1ì¡° í‰ê°€í•˜ê¸°</h2>
            <p id="teamMembers" class="members" style="font-size:1.1rem; margin-bottom: 30px;">ê¹€ìœ¤í¬, ë°•ë³´ê²½, ë°•í•˜ì§„, ì¡°ì€ìˆ™</p>
            
            <form id="evalForm">
                <div class="rating-row-large">
                    <span class="label">ğŸ’¡ ì°½ì˜ì„± (50%)</span>
                    <div class="radio-circles">
                        <label><input type="radio" name="c" value="5"><span>5</span></label>
                        <label><input type="radio" name="c" value="4"><span>4</span></label>
                        <label><input type="radio" name="c" value="3"><span>3</span></label>
                        <label><input type="radio" name="c" value="2"><span>2</span></label>
                        <label><input type="radio" name="c" value="1"><span>1</span></label>
                    </div>
                </div>

                <div class="rating-row-large">
                    <span class="label">ğŸ—ï¸ ì™„ì„±ë„ (40%)</span>
                    <div class="radio-circles">
                        <label><input type="radio" name="p" value="5"><span>5</span></label>
                        <label><input type="radio" name="p" value="4"><span>4</span></label>
                        <label><input type="radio" name="p" value="3"><span>3</span></label>
                        <label><input type="radio" name="p" value="2"><span>2</span></label>
                        <label><input type="radio" name="p" value="1"><span>1</span></label>
                    </div>
                </div>

                <div class="rating-row-large">
                    <span class="label">ğŸ¨ ë””ìì¸ (10%)</span>
                    <div class="radio-circles">
                        <label><input type="radio" name="d" value="5"><span>5</span></label>
                        <label><input type="radio" name="d" value="4"><span>4</span></label>
                        <label><input type="radio" name="d" value="3"><span>3</span></label>
                        <label><input type="radio" name="d" value="2"><span>2</span></label>
                        <label><input type="radio" name="d" value="1"><span>1</span></label>
                    </div>
                </div>

                <button type="submit" class="btn-primary" style="margin-top: 30px; padding: 20px; font-size:1.2rem;">í‰ê°€ ì œì¶œí•˜ê¸°</button>
            </form>
            
            <div id="currentScore" class="score-result" style="text-align:center; margin-top:30px; font-size:1.2rem;"></div>
        </div>
    </div>

    <!-- [í™”ë©´ í‘œì‹œìš© ìŠ¤í¬ë¦½íŠ¸] - 2ì¡° ì´ìƒì¼ ë•Œë§Œ ë‚´ìš©ì„ ë°”ê¿”ì¹˜ê¸° í•¨ -->
    <script>
        (function() {
            var teams = {
                'team_1': { name: '1ì¡°', members: 'ê¹€ìœ¤í¬, ë°•ë³´ê²½, ë°•í•˜ì§„, ì¡°ì€ìˆ™' },
                'team_2': { name: '2ì¡°', members: 'ê¹€ì„±ë•, ì†¡ì„œí¬, ë°•ì£¼ì—°, ê¹€ì‹ í˜œ' },
                'team_3': { name: '3ì¡°', members: 'ì—„ì•„ëŒ, ì„í™”ì •, ì˜¤ì•„ì˜, ì•ˆì§„ì˜' },
                'team_4': { name: '4ì¡°', members: 'ê¶Œì •ìœ¤, ê¹€ë¯¸ì§„, ì‹œì§€í˜œ' },
                'team_5': { name: '5ì¡°', members: 'ì‹ ë¡, ì„ë¹›ë‚˜, ì •ìœ ì§„, í™ì •í˜œ' },
                'team_6': { name: '6ì¡°', members: 'ë°•ë¯¼ì£¼, ë°•ìˆ˜ë€, ì„ë¯¼í¬, ë¥˜í˜„ì •' },
                'team_7': { name: '7ì¡°', members: 'ë³€ì§€ì„ , ì‹ ì„ í˜œ, ê°•ì •í•œ' },
                'team_8': { name: '8ì¡°', members: 'ìµœìš´ì˜,ê¹€ì˜ì€,ìœ¤í˜„ìˆ™,ì´ìœ¤ì •' },
                'team_9': { name: '9ì¡°', members: 'ì¡°í•œìˆ™, ê¹€ì˜ë¦¼, ìœ ìŠ¹í¬, ì´ìš©í¬' },
                'team_10': { name: '10ì¡°', members: 'ì§„ì°½ì™„, ì •ì˜ìˆ™, ê¹€í™ì§„, í•˜ë°±í™”' },
                'team_11': { name: '11ì¡°', members: 'ê¹€ì†Œì˜, ê¹€ì£¼í¬, ê¹€í•œì†”, ë°•ì˜ì• , ì‹ ìœ¤í•´, ìœ¤ìš°í¬' }
            };

            var params = new URLSearchParams(window.location.search);
            var tid = params.get('id');
            // ID ì—†ìœ¼ë©´ ë¬´ì¡°ê±´ team_1ë¡œ ê³ ì • (ì˜¤ë¥˜ ë°©ì§€)
            if (!tid || !teams[tid]) {
                tid = 'team_1';
            }

            // HTML ë‚´ìš© ë³€ê²½ (1ì¡°ì¼ ë•ŒëŠ” ì´ë¯¸ ì í˜€ìˆì–´ì„œ ë³€í™” ì—†ìŒ, 2ì¡°ì¼ ë•Œ ë°”ë€œ)
            var teamInfo = teams[tid];
            if (tid !== 'team_1' && teamInfo) {
                document.getElementById('teamName').textContent = teamInfo.name + ' í‰ê°€í•˜ê¸°';
                document.getElementById('teamMembers').textContent = teamInfo.members;
                document.getElementById('pageTitle').textContent = teamInfo.name + ' í‰ê°€';
            }
        })();
    </script>

    <!-- [íŒŒì´ì–´ë² ì´ìŠ¤ ë¡œì§] -->
    <script type="module">
        import { db } from './firebase-config.js';
        import { doc, setDoc, addDoc, collection, increment, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // íŒŒë¼ë¯¸í„° ë‹¤ì‹œ í™•ì¸ (ìœ„ì™€ ë™ì¼í•œ ë¡œì§ ì ìš©)
        const urlParams = new URLSearchParams(window.location.search);
        let teamId = urlParams.get('id');
        if (!teamId) teamId = 'team_1'; // ì•ˆì „ì¥ì¹˜

        // ì‹¤ì‹œê°„ ì ìˆ˜
        onSnapshot(doc(db, 'evaluations', teamId), (docSnap) => {
            const div = document.getElementById('currentScore');
            if (docSnap.exists()) {
                const data = docSnap.data();
                const count = data.count || 0;
                if (count > 0) {
                    const total = 20 * ((data.sum_creative/count * 0.5) + (data.sum_complete/count * 0.4) + (data.sum_design/count * 0.1));
                    div.innerHTML = `ğŸ† í˜„ì¬ í‰ì : <strong style="color:#4a90e2; font-size:1.5em;">${total.toFixed(1)}ì </strong> <span style="font-size:0.8em; color:#888;">(${count}ëª… ì°¸ì—¬)</span>`;
                }
            }
        });

        // ì œì¶œ í•¸ë“¤ëŸ¬
        document.getElementById('evalForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const cVal = parseInt(form.querySelector('input[name="c"]:checked')?.value || 0);
            const pVal = parseInt(form.querySelector('input[name="p"]:checked')?.value || 0);
            const dVal = parseInt(form.querySelector('input[name="d"]:checked')?.value || 0);

            if (!cVal || !pVal || !dVal) { alert('ëª¨ë“  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            if (!confirm('ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                // í•©ê³„
                await setDoc(doc(db, 'evaluations', teamId), {
                    count: increment(1),
                    sum_creative: increment(cVal),
                    sum_complete: increment(pVal),
                    sum_design: increment(dVal),
                    last_updated: serverTimestamp()
                }, { merge: true });

                // ë¡œê·¸
                const teamNameDisplay = document.getElementById('teamName').textContent.replace(' í‰ê°€í•˜ê¸°', '');
                await addDoc(collection(db, 'evaluation_logs'), {
                    teamId: teamId,
                    teamName: teamNameDisplay,
                    creative: cVal,
                    complete: pVal,
                    design: dVal,
                    timestamp: serverTimestamp()
                });

                alert('ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!');
                window.location.href = 'evaluate.html';
            } catch (err) {
                alert('ì „ì†¡ ì˜¤ë¥˜: ' + err.message);
            }
        });
    </script>
</body>
</html>
