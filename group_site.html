<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>조별사이트 등록 - 독서정보탐구</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        /* Specific styles for the form page */
        .form-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2.5rem;
            backdrop-filter: blur(12px);
            max-width: 600px;
            margin: 0 auto 2rem auto;
            text-align: left;
            animation: fadeInDown 0.8s ease-out;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #e2e8f0;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .submit-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .list-container {
            max-width: 800px;
            /* Slightly wider for the list */
            margin: 0 auto;
            animation: fadeInUp 0.8s ease-out 0.2s backwards;
        }

        .site-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
        }

        .site-card:hover {
            transform: scale(1.02);
            background: rgba(255, 255, 255, 0.08);
        }

        .site-info h3 {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
            color: #fff;
        }

        .site-meta {
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .site-link-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }

        .site-link-btn:hover {
            background: var(--accent-color);
            color: white;
        }

        .back-nav {
            margin-bottom: 2rem;
            text-align: left;
        }

        .back-link {
            color: #94a3b8;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: #fff;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 0.5rem;
            margin-left: 0.5rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .delete-btn:hover {
            opacity: 1;
        }

        @media (max-width: 600px) {
            .site-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .site-link-btn {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div class="background-animation"></div>

    <main class="container">
        <nav class="back-nav" style="display: flex; gap: 1rem; align-items: center;">
            <a href="index.html" class="back-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                홈으로
            </a>
        </nav>

        <h1 class="main-title" style="font-size: 2.5rem; margin-bottom: 2rem;">조별 사이트 등록</h1>

        <section class="form-container">
            <form id="groupSiteForm">
                <div class="form-group">
                    <label for="groupNumber" class="form-label">조 선택</label>
                    <select id="groupNumber" class="form-input" required>
                        <option value="" disabled selected>조를 선택하세요</option>
                        <option value="1">1조</option>
                        <option value="2">2조</option>
                        <option value="3">3조</option>
                        <option value="4">4조</option>
                        <option value="5">5조</option>
                        <option value="6">6조</option>
                        <option value="7">7조</option>
                        <option value="8">8조</option>
                        <option value="9">9조</option>
                        <option value="10">10조</option>
                        <option value="11">11조</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="participantNames" class="form-label">참여자 이름</label>
                    <input type="text" id="participantNames" class="form-input" placeholder="예: 김철수, 이영희, 박민수" required>
                </div>

                <div class="form-group">
                    <label for="siteTitle" class="form-label">사이트 제목</label>
                    <input type="text" id="siteTitle" class="form-input" placeholder="우리 조의 탐구 주제" required>
                </div>

                <div class="form-group">
                    <label for="siteUrl" class="form-label">사이트 URL</label>
                    <input type="url" id="siteUrl" class="form-input" placeholder="https://example.com" required>
                </div>

                <button type="submit" class="submit-btn">등록하기</button>
            </form>
        </section>

        <section class="list-container">
            <h2 style="color: #fff; margin-bottom: 1.5rem; text-align: left; font-size: 1.5rem;">등록된 사이트 목록</h2>
            <div id="siteList">
                <!-- Sites will be added here dynamically -->
            </div>
        </section>

        <div style="margin-top: 3rem; text-align: right; opacity: 0.8;">
            <button onclick="openSettings()" style="background:none; border:none; color:#cbd5e1; font-size:0.9rem; cursor:pointer; margin-right: 1rem;">⚙️ GitHub 설정</button>
            <button onclick="resetGroupData()"
                style="background:none; border:none; color:#94a3b8; font-size:0.8rem; cursor:pointer;">데이터 초기화
                (관리자용)</button>
        </div>
    </main>

    <!-- GitHub API Logic -->
    <script>
        // [중요] 선생님께서 이곳에 아이디와 저장소 이름을 직접 적어주세요.
        // 학생들은 별도 설정 없이 바로 이용할 수 있게 됩니다.
        let githubConfig = {
            owner: 'leebeekee',
            repo: 'digitaltool',
            path: 'data.json',
            token: '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' // 토큰은 설정 메뉴에서 입력해주세요 (보안상 코드에 포함하지 않음)
        };

        const DEFAULTS = {
            message: "Update group sites data",
            committer: {
                name: "Digital Tool Web",
                email: "web@digitaltool.com"
            }
        };

        // 전역 함수로 설정 열기 기능 노출
        window.openSettings = function() {
            const overlay = document.createElement('div');
            overlay.style.cssText = `position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:999;display:flex;justify-content:center;align-items:center;`;
            
            const box = document.createElement('div');
            box.className = 'form-container'; 
            box.style.margin = '0';
            box.style.width = '90%';
            
            box.innerHTML = `
                <h2 style="margin-bottom:1.5rem; color:#fff;">GitHub 연동 설정</h2>
                <p style="color:#cbd5e1; margin-bottom:1rem; font-size:0.9rem;">
                    데이터를 저장할 GitHub 리포지토리 정보를 입력하세요.<br>
                    입력한 토큰은 브라우저에만 저장됩니다.
                </p>
                <div class="form-group">
                    <label class="form-label">GitHub 아이디 (Owner)</label>
                    <input type="text" id="gh_owner" class="form-input" value="${githubConfig.owner}" placeholder="예: username">
                </div>
                <div class="form-group">
                    <label class="form-label">리포지토리 이름 (Repo)</label>
                    <input type="text" id="gh_repo" class="form-input" value="${githubConfig.repo}" placeholder="예: digitalTool">
                </div>
                <div class="form-group">
                    <label class="form-label">Personal Access Token</label>
                    <input type="password" id="gh_token" class="form-input" value="${githubConfig.token}" placeholder="ghp_...">
                </div>
                <div style="display:flex; gap:1rem;">
                    <button id="saveConfig" class="submit-btn">저장</button>
                    <button id="closeConfig" class="submit-btn" style="background:#475569;">닫기</button>
                </div>
            `;

            overlay.appendChild(box);
            document.body.appendChild(overlay);

            document.getElementById('saveConfig').onclick = () => {
                const newConfig = {
                    owner: document.getElementById('gh_owner').value.trim(),
                    repo: document.getElementById('gh_repo').value.trim(),
                    token: document.getElementById('gh_token').value.trim(),
                    path: 'data.json'
                };

                if (!newConfig.owner || !newConfig.repo || !newConfig.token) {
                    alert("모든 항목을 입력해주세요.");
                    return;
                }

                githubConfig = newConfig;
                localStorage.setItem('gh_config_v2', JSON.stringify(githubConfig));
                document.body.removeChild(overlay);
                // After saving, try to load sites
                if (typeof loadSitesFromGithub === 'function') {
                    loadSitesFromGithub();
                } else {
                    location.reload(); // Simple reload if function not accessible
                }
            };

            document.getElementById('closeConfig').onclick = () => {
                document.body.removeChild(overlay);
            };
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadConfig(); // 저장된 설정 불러오기

            const form = document.getElementById('groupSiteForm');
            const siteList = document.getElementById('siteList');
            
            // Check if config is ready
            if (githubConfig.token && githubConfig.owner !== 'Github_아이디_입력') {
                loadSitesFromGithub();
            } else {
                siteList.innerHTML = '<p style="color:#bfdbfe; text-align:center; padding:2rem;">GitHub 연동이 필요합니다.<br>우측 하단 ⚙️ 설정 버튼을 눌러 토큰을 입력해주세요.</p>';
            }

            // 폼 제출 핸들러
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!githubConfig.token || !githubConfig.repo) {
                    alert("먼저 GitHub 연동 설정을 완료해주세요.");
                    openSettings();
                    return;
                }

                const submitBtn = form.querySelector('.submit-btn');
                const originalText = submitBtn.innerText;
                submitBtn.innerText = "GitHub 저장소에 기록 중... (약 5초)";
                submitBtn.disabled = true;

                try {
                    // 1. 기존 데이터 가져오기
                    const currentData = await fetchFileContent();

                    // 2. 새 데이터 추가
                    const newSite = {
                        id: Date.now(),
                        group: parseInt(document.getElementById('groupNumber').value),
                        participants: document.getElementById('participantNames').value,
                        title: document.getElementById('siteTitle').value,
                        url: document.getElementById('siteUrl').value,
                        createdAt: new Date().toISOString()
                    };

                    currentData.content.push(newSite);

                    // 3. 파일 업데이트 (Commit)
                    await updateFileContent(currentData.content, currentData.sha);

                    alert("성공적으로 저장되었습니다! \n주의: GitHub Pages에 반영되기까지 1~2분 정도 걸릴 수 있습니다.");
                    form.reset();
                    renderSites(currentData.content);

                } catch (error) {
                    console.error(error);
                    alert("저장 실패: " + error.message);
                    if (error.message.includes("401")) {
                        alert("권한 오류(401)가 발생했습니다. 토큰이 만료되었거나 권한이 없습니다. 설정을 확인해주세요.");
                        openSettings();
                    }
                } finally {
                    submitBtn.innerText = originalText;
                    submitBtn.disabled = false;
                }
            });

            // --- GitHub API Functions ---

            async function fetchFileContent() {
                const url = `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.path}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 404) return { content: [], sha: null }; // 파일이 없으면 빈 배열
                    throw new Error(`GitHub 통신 오류 (${response.status})`);
                }

                const data = await response.json();
                // GitHub returns base64 content with newlines
                const decodedContent = decodeURIComponent(escape(atob(data.content.replace(/\n/g, ""))));
                return {
                    content: JSON.parse(decodedContent),
                    sha: data.sha
                };
            }

            async function updateFileContent(newContent, sha) {
                const url = `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.path}`;

                // 한글 깨짐 방지를 위한 Base64 인코딩
                const contentString = JSON.stringify(newContent, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(contentString)));

                const body = {
                    message: DEFAULTS.message,
                    committer: DEFAULTS.committer,
                    content: encodedContent
                };
                if (sha) body.sha = sha; // 기존 파일 업데이트 시 sha 필수

                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) throw new Error("저장에 실패했습니다. 권한을 확인해주세요.");
            }

            window.deleteSite = async function (id) {
                if (!confirm('정말 삭제하시겠습니까? (GitHub 커밋이 발생합니다)')) return;

                try {
                    const currentData = await fetchFileContent();
                    const newContent = currentData.content.filter(s => s.id !== id);
                    await updateFileContent(newContent, currentData.sha);
                    renderSites(newContent);
                    alert("삭제되었습니다. 반영까지 시간이 걸릴 수 있습니다.");
                } catch (e) {
                    alert("삭제 오류: " + e.message);
                }
            };


            // --- UI & Helper Functions ---

            // make globally available so openSettings can call it
            window.loadSitesFromGithub = async function() {
                const siteList = document.getElementById('siteList');
                if(!siteList) return;
                
                siteList.innerHTML = '<p style="color:#fff; text-align:center;">데이터 불러오는 중...</p>';
                try {
                    const data = await fetchFileContent();
                    data.content.sort((a, b) => a.group - b.group);
                    renderSites(data.content);
                } catch (e) {
                    renderEmptyState("데이터 로드 실패: " + e.message);
                    if(e.message.includes('401')) {
                         siteList.innerHTML += '<p style="text-align:center; margin-top:1rem;"><button onclick="openSettings()" style="background:#475569; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">설정 확인</button></p>';
                    }
                }
            }

            function renderSites(sites) {
                siteList.innerHTML = '';
                if (!sites || sites.length === 0) {
                    renderEmptyState("등록된 사이트가 없습니다.");
                    return;
                }

                sites.forEach(site => {
                    const card = document.createElement('div');
                    card.className = 'site-card';
                    card.innerHTML = `
                        <div class="site-info" style="text-align: left;">
                            <span style="display: inline-block; padding: 0.25rem 0.75rem; background: var(--primary-color); border-radius: 999px; font-size: 0.8rem; margin-bottom: 0.5rem; color: white;">${site.group}조</span>
                            <h3>${site.title}</h3>
                            <div class="site-meta">참여: ${site.participants}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
                            <a href="${site.url}" target="_blank" class="site-link-btn" style="flex:1; text-align:center;">방문하기</a>
                            <button class="delete-btn" onclick="deleteSite(${site.id})">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    `;
                    siteList.appendChild(card);
                });
            }

            function renderEmptyState(msg) {
                siteList.innerHTML = `<p style="color: #94a3b8; padding: 2rem; text-align: center;">${msg}</p>`;
            }

            function loadConfig() {
                const saved = localStorage.getItem('gh_config_v2');
                if (saved) githubConfig = JSON.parse(saved);
            }
        });
    </script>
</body>

</html>